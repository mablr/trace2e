services:
  # User Node - Creates and sends CV
  user-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-node
    hostname: user-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.10
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://172.20.0.10:50051
      - RUST_LOG=trace2e_core=debug
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - user-data:/tmp
    command: /app/trace2e_middleware --address 172.20.0.10 --port 50051 --consent-timeout 30000
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Company Node - Receives CV, may forward
  company-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: company-node
    hostname: company-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.20
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://172.20.0.20:50051
      - RUST_LOG=trace2e_core=debug
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - company-data:/tmp
    command: /app/trace2e_middleware --address 172.20.0.20 --port 50051 --consent-timeout 30000
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      user-node:
        condition: service_healthy

  # Recruiter Node - Third party that may receive forwarded CV
  recruiter-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recruiter-node
    hostname: recruiter-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.30
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://172.20.0.30:50051
      - RUST_LOG=trace2e_core=debug
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - recruiter-data:/tmp
    command: /app/trace2e_middleware --address 172.20.0.30 --port 50051 --consent-timeout 30000
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      company-node:
        condition: service_healthy

networks:
  trace2e-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  user-data:
  company-data:
  recruiter-data:
