version: '3.8'

services:
  # User Node - Creates and sends CV
  user-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-node
    hostname: user-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.10
    ports:
      - "50051:50051"  # P2M/O2M access from host
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://user-node:50051
      - NODE_NAME=user-node
      - NODE_IP=172.20.0.10
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - user-data:/tmp
    command: /app/trace2e_middleware --address 0.0.0.0 --port 50051 --consent-timeout 30
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Company Node - Receives CV, may forward
  company-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: company-node
    hostname: company-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.20
    ports:
      - "50052:50051"  # Different host port for access
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://company-node:50051
      - NODE_NAME=company-node
      - NODE_IP=172.20.0.20
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - company-data:/tmp
    command: /app/trace2e_middleware --address 0.0.0.0 --port 50051 --consent-timeout 30
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      user-node:
        condition: service_healthy

  # Recruiter Node - Third party that may receive forwarded CV
  recruiter-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recruiter-node
    hostname: recruiter-node
    networks:
      trace2e-net:
        ipv4_address: 172.20.0.30
    ports:
      - "50053:50051"
    environment:
      - TRACE2E_MIDDLEWARE_URL=http://recruiter-node:50051
      - NODE_NAME=recruiter-node
      - NODE_IP=172.20.0.30
    volumes:
      - ./demo/playbooks:/app/playbooks:ro
      - ./demo/data:/app/data
      - recruiter-data:/tmp
    command: /app/trace2e_middleware --address 0.0.0.0 --port 50051 --consent-timeout 30
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -tlnp | grep 50051"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      company-node:
        condition: service_healthy

networks:
  trace2e-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  user-data:
  company-data:
  recruiter-data:
